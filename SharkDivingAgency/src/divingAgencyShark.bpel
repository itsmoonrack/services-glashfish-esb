<?xml version="1.0" encoding="UTF-8"?>
<process
    name="divingAgencyShark"
    targetNamespace="http://enterprise.netbeans.org/bpel/DivingAgencyShark/divingAgencyShark"
    xmlns:tns="http://enterprise.netbeans.org/bpel/DivingAgencyShark/divingAgencyShark"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor"
    xmlns:sxeh="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/ErrorHandling" xmlns:sxed2="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor2" xmlns:ns0="http://j2ee.netbeans.org/xsd/tableSchema" xmlns:ns1="http://xml.netbeans.org/schema/Exchanges">
    <import namespace="http://j2ee.netbeans.org/wsdl/ProcessManager/DivingSharkRequest" location="DivingSharkRequest.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://j2ee.netbeans.org/wsdl/DivingAgencyShark/divingAgencySharkBookingTable" location="divingAgencySharkBookingTable.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://j2ee.netbeans.org/wsdl/DivingAgencyShark/divingAgencySharkPlaningTable" location="divingAgencySharkPlaningTable.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <partnerLinks>
        <partnerLink name="PlaningTable" xmlns:tns="http://j2ee.netbeans.org/wsdl/DivingAgencyShark/divingAgencySharkPlaningTable" partnerLinkType="tns:jdbcpartner" partnerRole="jdbcPortTypeRole"/>
        <partnerLink name="BookingTable" xmlns:tns="http://j2ee.netbeans.org/wsdl/DivingAgencyShark/divingAgencySharkBookingTable" partnerLinkType="tns:jdbcpartner" partnerRole="jdbcPortTypeRole"/>
        <partnerLink name="ProcessManager" xmlns:tns="http://j2ee.netbeans.org/wsdl/ProcessManager/DivingSharkRequest" partnerLinkType="tns:DivingSharkRequest" myRole="DivingSharkRequestPortTypeRole"/>
    </partnerLinks>
    <variables>
        <variable name="FindOutBookingId" xmlns:tns="http://j2ee.netbeans.org/wsdl/DivingAgencyShark/divingAgencySharkBookingTable" messageType="tns:outputMsg"/>
        <variable name="FindInBookingId" xmlns:tns="http://j2ee.netbeans.org/wsdl/DivingAgencyShark/divingAgencySharkBookingTable" messageType="tns:inputMsg"/>
        <variable name="InsertOutBooking" xmlns:tns="http://j2ee.netbeans.org/wsdl/DivingAgencyShark/divingAgencySharkBookingTable" messageType="tns:RetMsg"/>
        <variable name="InsertInBooking" xmlns:tns="http://j2ee.netbeans.org/wsdl/DivingAgencyShark/divingAgencySharkBookingTable" messageType="tns:inputMsg"/>
        <variable name="FindOutInstructorName" xmlns:tns="http://j2ee.netbeans.org/wsdl/DivingAgencyShark/divingAgencySharkPlaningTable" messageType="tns:outputMsg"/>
        <variable name="FindInInstructorName" xmlns:tns="http://j2ee.netbeans.org/wsdl/DivingAgencyShark/divingAgencySharkPlaningTable" messageType="tns:inputMsg"/>
        <variable name="DivingSharkRequestOperationOut" xmlns:tns="http://j2ee.netbeans.org/wsdl/ProcessManager/DivingSharkRequest" messageType="tns:DivingSharkRequestOperationResponse"/>
        <variable name="DivingSharkRequestOperationIn" xmlns:tns="http://j2ee.netbeans.org/wsdl/ProcessManager/DivingSharkRequest" messageType="tns:DivingSharkRequestOperationRequest"/>
    </variables>
    <sequence>
        <receive name="Receive1" createInstance="yes" partnerLink="ProcessManager" operation="DivingSharkRequestOperation" xmlns:tns="http://j2ee.netbeans.org/wsdl/ProcessManager/DivingSharkRequest" portType="tns:DivingSharkRequestPortType" variable="DivingSharkRequestOperationIn">
            <sxt:trace>
                <sxt:log level="info" location="onStart">
                    <from>"divingSharkAgency : Reception d'une demande de reservation d'une sortie sous-marine"</from>
                </sxt:log>
            </sxt:trace>
        </receive>
        <assign name="mapDay">
            <copy>
                <from>substring(string($DivingSharkRequestOperationIn.request/ns1:requestDate), 9, 2)</from>
                <to>$FindInInstructorName.part/ns0:PLANING_Record/ns0:JOUR</to>
            </copy>
        </assign>
        <invoke name="getInstructorName" partnerLink="PlaningTable" operation="find" xmlns:tns="http://j2ee.netbeans.org/wsdl/DivingAgencyShark/divingAgencySharkPlaningTable" portType="tns:jdbcPortType" inputVariable="FindInInstructorName" outputVariable="FindOutInstructorName">
            <sxt:trace>
                <sxt:log level="info" location="onStart">
                    <from>"divingSharkAgency : recherche d'informations sur le planning dans la bdd"</from>
                </sxt:log>
                <sxt:log level="info" location="onComplete">
                    <from>'divingSharkAgency : Recuperation des informations sur le planning venant de la bdd'</from>
                </sxt:log>
            </sxt:trace>
        </invoke>
        <assign name="mapDataToInsert">
            <copy>
                <from>$DivingSharkRequestOperationIn.request/ns1:BookingName</from>
                <to>$InsertInBooking.part/ns0:BOOKING_Record/ns0:BOOKINGNAME</to>
            </copy>
            <copy>
                <from>$DivingSharkRequestOperationIn.request/ns1:hotelName</from>
                <to>$InsertInBooking.part/ns0:BOOKING_Record/ns0:HOTELNAME</to>
            </copy>
            <copy>
                <from>$DivingSharkRequestOperationIn.request/ns1:requestDate</from>
                <to>$InsertInBooking.part/ns0:BOOKING_Record/ns0:REQUESTDATE</to>
            </copy>
            <copy>
                <from>$DivingSharkRequestOperationIn.request/ns1:numberOfDivers</from>
                <to>$InsertInBooking.part/ns0:BOOKING_Record/ns0:NUMBEROFDIVERS</to>
            </copy>
            <copy>
                <from>$DivingSharkRequestOperationIn.request/ns1:numberOfDivers * 200</from>
                <to>$InsertInBooking.part/ns0:BOOKING_Record/ns0:PRICE</to>
            </copy>
            <copy>
                <from>'5, all√©e des requins'</from>
                <to>$InsertInBooking.part/ns0:BOOKING_Record/ns0:ADRESS</to>
            </copy>
            <copy>
                <from>$FindOutInstructorName.part/ns0:PLANING_Record/ns0:INSTRUCTORNAME</from>
                <to>$InsertInBooking.part/ns0:BOOKING_Record/ns0:INSTRUCTORNAME</to>
            </copy>
            <copy>
                <from>concat(string($DivingSharkRequestOperationIn.request/ns1:requestDate), ' ', '9:00:00')</from>
                <to>$InsertInBooking.part/ns0:BOOKING_Record/ns0:STARTTIME</to>
            </copy>
            <copy>
                <from>concat(string($DivingSharkRequestOperationIn.request/ns1:requestDate), ' ', '20:00:00')</from>
                <to>$InsertInBooking.part/ns0:BOOKING_Record/ns0:ENDTIME</to>
            </copy>
        </assign>
        <invoke name="insertBooking" partnerLink="BookingTable" operation="insert" xmlns:tns="http://j2ee.netbeans.org/wsdl/DivingAgencyShark/divingAgencySharkBookingTable" portType="tns:jdbcPortType" inputVariable="InsertInBooking" outputVariable="InsertOutBooking">
            <sxt:trace>
                <sxt:log level="info" location="onStart">
                    <from>'divingSharkAgency : Ajout de la reservation dan la bdd'</from>
                </sxt:log>
            </sxt:trace>
        </invoke>
        <assign name="mapDataToGetBookingId">
            <copy>
                <from>$DivingSharkRequestOperationIn.request/ns1:BookingName</from>
                <to>$FindInBookingId.part/ns0:BOOKING_Record/ns0:BOOKINGNAME</to>
            </copy>
            <copy>
                <from>$DivingSharkRequestOperationIn.request/ns1:hotelName</from>
                <to>$FindInBookingId.part/ns0:BOOKING_Record/ns0:HOTELNAME</to>
            </copy>
            <copy>
                <from>$DivingSharkRequestOperationIn.request/ns1:requestDate</from>
                <to>$FindInBookingId.part/ns0:BOOKING_Record/ns0:REQUESTDATE</to>
            </copy>
            <copy>
                <from>$DivingSharkRequestOperationIn.request/ns1:numberOfDivers</from>
                <to>$FindInBookingId.part/ns0:BOOKING_Record/ns0:NUMBEROFDIVERS</to>
            </copy>
        </assign>
        <invoke name="getBookingId" partnerLink="BookingTable" operation="find" xmlns:tns="http://j2ee.netbeans.org/wsdl/DivingAgencyShark/divingAgencySharkBookingTable" portType="tns:jdbcPortType" inputVariable="FindInBookingId" outputVariable="FindOutBookingId">
            <sxt:trace>
                <sxt:log level="info" location="onStart">
                    <from>"divingSharkAgency : recuperation de l'IDBooking dans la bdd"</from>
                </sxt:log>
            </sxt:trace>
        </invoke>
        <assign name="mapBookingData">
            <copy>
                <from>$FindOutBookingId.part/ns0:BOOKING_Record/ns0:BOOKINGID</from>
                <to>$DivingSharkRequestOperationOut.responce/ns1:divingBookingID</to>
            </copy>
            <copy>
                <from>$FindOutBookingId.part/ns0:BOOKING_Record/ns0:STARTTIME</from>
                <to>$DivingSharkRequestOperationOut.responce/ns1:startTime</to>
            </copy>
            <copy>
                <from>$FindOutBookingId.part/ns0:BOOKING_Record/ns0:ENDTIME</from>
                <to>$DivingSharkRequestOperationOut.responce/ns1:endTime</to>
            </copy>
            <copy>
                <from>$FindOutBookingId.part/ns0:BOOKING_Record/ns0:INSTRUCTORNAME</from>
                <to>$DivingSharkRequestOperationOut.responce/ns1:instructorName</to>
            </copy>
            <copy>
                <from>$FindOutBookingId.part/ns0:BOOKING_Record/ns0:ADRESS</from>
                <to>$DivingSharkRequestOperationOut.responce/ns1:address</to>
            </copy>
            <copy>
                <from>$FindOutBookingId.part/ns0:BOOKING_Record/ns0:PRICE</from>
                <to>$DivingSharkRequestOperationOut.responce/ns1:price</to>
            </copy>
            <copy>
                <from>'Agence tout requin'</from>
                <to>$DivingSharkRequestOperationOut.responce/ns1:divingAgencyName</to>
            </copy>
        </assign>
        <reply name="Reply1" partnerLink="ProcessManager" operation="DivingSharkRequestOperation" xmlns:tns="http://j2ee.netbeans.org/wsdl/ProcessManager/DivingSharkRequest" portType="tns:DivingSharkRequestPortType" variable="DivingSharkRequestOperationOut">
            <sxt:trace>
                <sxt:log level="info" location="onStart">
                    <from>'divingSharkAgency : Envoi de la reservation au process Manager'</from>
                </sxt:log>
            </sxt:trace>
        </reply>
    </sequence>
</process>


